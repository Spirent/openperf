#
# Makefile component for API unit tests
#

API_TEST_REQ_VARS := \
	ICP_ROOT \
	ICP_BUILD_ROOT
$(call icp_check_vars,$(ICP_REQ_VARS))

API_TEST_SRC_DIR := $(ICP_ROOT)/src/modules/api
API_TEST_OBJ_DIR := $(ICP_BUILD_ROOT)/obj/modules/api
API_TEST_LIB_DIR := $(ICP_BUILD_ROOT)/lib

# We explicitly state our includes, e.g. include module/<header.h>
ICP_INC_DIRS += $(API_TEST_INC_DIR)
ICP_LIB_DIRS += $(API_TEST_LIB_DIR)

API_TEST_SOURCES :=
API_TEST_OBJECTS :=
API_TEST_DEPENDS :=
API_TEST_LDLIBS  :=

include $(ICP_ROOT)/mk/versions.mk
include $(API_TEST_SRC_DIR)/module.mk

# Generate a list of object files from the API_TEST_SOURCES variable
# and translate the path from the SRC to the BUILD directory
API_TEST_OBJECTS += $(patsubst %, $(API_TEST_OBJ_DIR)/%, \
	$(patsubst %.c, %.o, $(filter %.c, $(API_TEST_SOURCES))))

API_TEST_OBJECTS += $(patsubst %, $(API_TEST_OBJ_DIR)/%, \
	$(patsubst %.cpp, %.o, $(filter %.cpp, $(API_TEST_SOURCES))))

API_TEST_LIBRARY := icp_api_test
API_TEST_TARGET := $(API_TEST_LIB_DIR)/lib$(API_TEST_LIBRARY).a

###
# Pull in dependencies, maybe...
# Hopefully, these are generated by the compiler
###
-include $(API_TEST_OBJECTS:.o=.d)

# Update library build options before loading dependencies. That way
# archive ordering should be correct.
ICP_LDLIBS += -Wl,--whole-archive -l$(API_TEST_LIBRARY) -Wl,--no-whole-archive $(API_TEST_LDLIBS)

# Load external dependencies, too
$(foreach DEP, $(API_TEST_DEPENDS), $(eval include $(ICP_ROOT)/mk/$(DEP).mk))

###
# Build rules
###
$(API_TEST_OBJECTS): | $(API_TEST_DEPENDS)

$(API_TEST_OBJ_DIR)/%.o: $(API_TEST_SRC_DIR)/%.c
	@mkdir -p $(dir $@)
	$(strip $(ICP_CC) -o $@ -c $(ICP_CPPFLAGS) $(ICP_CFLAGS) $(ICP_COPTS) $(ICP_DEFINES) $<)

$(API_TEST_OBJ_DIR)/%.o: $(API_TEST_SRC_DIR)/%.cpp
	@mkdir -p $(dir $@)
	$(strip $(ICP_CXX) -o $@ -c $(ICP_CPPFLAGS) $(ICP_CXXFLAGS) $(ICP_COPTS) $(ICP_DEFINES) $<)

$(API_TEST_TARGET): $(API_TEST_OBJECTS)
	@mkdir -p $(dir $@)
	$(strip $(ICP_AR) $(ICP_ARFLAGS) $@ $(API_TEST_OBJECTS))

.PHONY: api_test
api_test: $(API_TEST_TARGET)

.PHONY: clean_api_test
clean_api_test:
	@rm -rf $(API_TEST_OBJ_DIR) $(API_TEST_TARGET)
clean: clean_api_test
