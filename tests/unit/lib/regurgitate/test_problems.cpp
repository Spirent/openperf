#include <algorithm>

#include "catch.hpp"

#include "regurgitate/regurgitate.hpp"

static constexpr unsigned compression = 16;
using test_digest = regurgitate::digest<float, float, compression>;

template <typename Digest> void verify_digest(const Digest& digest)
{
    auto centroids = digest.get();

    REQUIRE(std::is_sorted(std::begin(centroids),
                           std::end(centroids),
                           [](const auto& lhs, const auto& rhs) {
                               return (lhs.first < rhs.first);
                           }));
}

template <typename Container> void verify_test_data(const Container& c)
{
    auto digest = test_digest();
    std::for_each(std::begin(c), std::end(c), [&](const auto& pair) {
        digest.insert(pair.first, pair.second);
    });
    digest.merge();
    verify_digest(digest);
}

/*
 * Each section contains a problematic dataset that caused problems during
 * development.
 */

TEST_CASE("problematic input", "[regurgitate]")
{
    SECTION("problem 1")
    {
        auto test_data = std::vector<std::pair<float, float>>{
            {10588.000000, 1.000000},
            {194296.375000, 476.000000},
            {403363.750000, 3615.000000},
            {404791.718750, 464267.000000},
            {408960.406250, 1823016.000000},
            {415441.156250, 221918016.000000},
            {418710.437500, 644102016.000000},
            {430571.125000, 5604939.000000},
            {622592.000000, 1.000000},
            {622592.000000, 1.000000},
            {622592.000000, 1.000000},
            {622592.000000, 1.000000},
            {622593.000000, 1.000000},
            {622593.000000, 1.000000},
            {622593.000000, 1.000000},
            {622593.000000, 1.000000},
            {622593.000000, 1.000000},
            {624832.000000, 1.000000},
            {624832.000000, 1.000000},
            {624832.000000, 1.000000},
            {624832.000000, 1.000000},
            {624833.000000, 1.000000},
            {624833.000000, 1.000000},
            {624833.000000, 1.000000},
            {624833.000000, 1.000000},
            {624833.000000, 1.000000},
            {625685.000000, 1.000000},
            {625686.000000, 1.000000},
            {625686.000000, 1.000000},
            {625686.000000, 1.000000},
            {625686.000000, 1.000000},
            {626324.000000, 1.000000},
            {626324.000000, 1.000000},
            {627761.687500, 33636.000000},
            {629106.000000, 1.000000},
            {629106.000000, 1.000000},
            {629106.000000, 1.000000},
            {629106.000000, 1.000000},
            {629106.000000, 1.000000},
            {629106.000000, 1.000000},
            {629107.000000, 1.000000},
            {629107.000000, 1.000000},
            {629107.000000, 1.000000},
            {629107.000000, 1.000000},
            {629107.000000, 1.000000},
            {629107.000000, 1.000000},
            {629107.000000, 1.000000},
            {629107.000000, 1.000000},
            {629107.000000, 1.000000},
            {629108.000000, 1.000000},
            {629108.000000, 1.000000},
            {629108.000000, 1.000000},
            {629108.000000, 1.000000},
            {629108.000000, 1.000000},
            {629108.000000, 1.000000},
            {629108.000000, 1.000000},
            {629109.000000, 1.000000}};

        verify_test_data(test_data);
    }

    SECTION("problem 2")
    {
        auto test_data = std::vector<std::pair<float, float>>{
            {180856.000000, 1.000000},  {180857.000000, 1.000000},
            {180857.000000, 4.000000},  {180857.250000, 8.000000},
            {180858.000000, 8.000000},  {189500.328125, 18.000000},
            {200303.312500, 19.000000}, {210981.875000, 33.000000},
            {218980.078125, 41.000000}, {223367.234375, 51.000000},
            {227465.734375, 31.000000}, {228751.859375, 15.000000},
            {230433.000000, 1.000000},  {230433.000000, 1.000000},
            {230433.000000, 1.000000},  {230433.000000, 1.000000},
            {230434.000000, 1.000000},  {230434.000000, 1.000000},
            {230434.000000, 1.000000},  {230434.000000, 1.000000},
            {230434.000000, 1.000000},  {230434.328125, 6.000000},
            {230435.000000, 1.000000},  {230435.000000, 1.000000},
            {230435.000000, 1.000000},  {230435.000000, 1.000000},
            {230435.000000, 1.000000},  {230435.000000, 2.000000},
            {230435.000000, 1.000000},  {230435.000000, 1.000000},
            {230435.000000, 1.000000},  {230436.000000, 1.000000},
            {231398.000000, 1.000000},  {231399.000000, 1.000000},
            {231399.000000, 1.000000},  {231399.000000, 1.000000},
            {231399.000000, 1.000000},  {231399.000000, 1.000000},
            {231399.000000, 1.000000},  {231399.000000, 1.000000},
            {231399.000000, 1.000000},  {231399.000000, 1.000000},
            {231399.000000, 1.000000},  {231399.000000, 1.000000},
            {231400.000000, 1.000000},  {231400.000000, 1.000000},
            {231400.000000, 1.000000},  {231400.000000, 1.000000},
            {231400.000000, 1.000000},  {231400.000000, 1.000000},
            {231400.000000, 1.000000},  {231400.000000, 1.000000},
            {231400.000000, 1.000000},  {231400.000000, 1.000000},
            {231400.000000, 1.000000},  {231400.000000, 1.000000},
            {231400.000000, 1.000000},  {231400.000000, 1.000000},
            {231401.000000, 1.000000},  {231401.000000, 1.000000},
            {231401.000000, 1.000000},  {231401.000000, 1.000000},
            {231401.000000, 1.000000},  {231401.000000, 1.000000}};

        verify_test_data(test_data);
    }

    SECTION("problem 3")
    {
        auto test_data = std::vector<std::pair<float, float>>{
            {31333.195312, 736.000000},
            {58540.195312, 8958.000000},
            {117892.437500, 80960.000000},
            {250785.265625, 449931.000000},
            {421967.281250, 6400012.000000},
            {436143.937500, 383432064.000000},
            {439341.031250, 375240992.000000},
            {479607.250000, 246369856.000000},
            {519300.625000, 13604281.000000},
            {612981.125000, 354272.000000},
            {784703.750000, 11823.000000},
            {1019028.625000, 866.000000},
            {1054548.000000, 1.000000},
            {1054549.000000, 1.000000},
            {1054549.000000, 1.000000},
            {1054549.000000, 1.000000},
            {1054549.000000, 1.000000},
            {1054549.000000, 1.000000},
            {1054550.000000, 1.000000},
            {1065969.000000, 1.000000},
            {1065969.000000, 1.000000},
            {1065970.000000, 1.000000},
            {1065970.000000, 1.000000},
            {1065970.000000, 1.000000},
            {1065970.000000, 1.000000},
            {1065970.000000, 1.000000},
            {1065970.000000, 1.000000},
            {1065971.000000, 1.000000},
            {1076482.000000, 1.000000},
            {1076482.000000, 1.000000},
            {1076483.000000, 1.000000},
            {1076483.000000, 1.000000},
            {1076483.000000, 1.000000},
            {1076483.000000, 1.000000},
            {1076483.000000, 1.000000},
            {1076483.000000, 1.000000},
            {1076483.000000, 1.000000},
            {1076483.000000, 1.000000},
            {1076483.000000, 1.000000},
            {1076483.000000, 1.000000},
            {1076483.000000, 1.000000},
            {1076483.000000, 1.000000},
            {1076483.000000, 1.000000},
            {1076484.000000, 1.000000},
            {1076484.000000, 1.000000},
            {1076484.000000, 1.000000},
            {1076484.000000, 1.000000},
            {1076484.000000, 1.000000},
            {1076484.000000, 1.000000},
            {1076484.000000, 1.000000},
            {1076484.000000, 1.000000},
            {1076484.000000, 1.000000},
            {1076484.000000, 1.000000},
            {1076484.000000, 1.000000},
            {1076485.000000, 1.000000},
            {1076485.000000, 1.000000},
            {1076485.000000, 1.000000},
            {1076485.000000, 1.000000},
            {1076485.000000, 1.000000},
            {1076485.000000, 1.000000}};

        verify_test_data(test_data);
    }

    SECTION("problem 4")
    {
        auto test_data = std::vector<std::pair<float, float>>{

            {300621.406250, 235599216.000000},
            {300621.437500, 238902640.000000},
            {438111.000000, 14401422.000000},
            {519990.093750, 163666.000000},
            {674971.312500, 14210.000000},
            {719968.250000, 1545.000000},
            {735970.000000, 1.000000},
            {735970.000000, 1.000000},
            {735970.000000, 1.000000},
            {735970.000000, 1.000000},
            {735970.000000, 1.000000},
            {742372.625000, 25.000000},
            {742505.000000, 1.000000},
            {742505.000000, 1.000000},
            {742505.000000, 1.000000},
            {742505.000000, 1.000000},
            {742506.000000, 1.000000},
            {742506.000000, 1.000000},
            {742506.000000, 1.000000},
            {742506.000000, 1.000000},
            {742506.000000, 1.000000},
            {745973.000000, 1.000000},
            {745974.000000, 1.000000},
            {745974.000000, 1.000000},
            {745974.000000, 1.000000},
            {745974.000000, 1.000000},
            {745974.000000, 1.000000},
            {745975.000000, 1.000000},
            {748029.000000, 1.000000},
            {748029.000000, 1.000000},
            {748029.000000, 1.000000},
            {748029.000000, 1.000000},
            {748030.000000, 1.000000},
            {748030.000000, 1.000000},
            {748030.000000, 1.000000},
            {748030.000000, 1.000000},
            {748030.000000, 1.000000},
            {748030.000000, 1.000000},
            {748030.000000, 1.000000},
            {748030.000000, 1.000000},
            {748030.000000, 1.000000},
            {748030.000000, 1.000000},
            {748030.000000, 1.000000},
            {748030.000000, 1.000000},
            {748031.000000, 1.000000},
            {748031.000000, 1.000000},
            {748031.000000, 1.000000},
            {748031.000000, 1.000000},
            {748031.000000, 1.000000},
            {748031.000000, 1.000000},
            {748031.000000, 1.000000},
            {748031.000000, 1.000000},
            {748031.000000, 1.000000},
            {748031.000000, 1.000000},
            {748031.000000, 1.000000},
            {748031.000000, 1.000000},
            {748031.000000, 1.000000},
            {748032.000000, 1.000000},
            {748032.000000, 1.000000},
            {748032.000000, 1.000000}};

        verify_test_data(test_data);
    }

    SECTION("problem 5")
    {
        auto test_data = std::vector<std::pair<float, float>>{
            {73731.617188, 2572.000000},
            {210760.937500, 3493.000000},
            {290924.843750, 138369440.000000},
            {290924.843750, 158342480.000000},
            {439629.250000, 3950317.000000},
            {555746.312500, 435815.000000},
            {692915.687500, 34013.000000},
            {722215.000000, 1.000000},
            {722216.000000, 1.000000},
            {722216.000000, 1.000000},
            {722216.000000, 1.000000},
            {722216.000000, 1.000000},
            {722216.000000, 1.000000},
            {722216.000000, 1.000000},
            {722217.000000, 1.000000},
            {722217.000000, 1.000000},
            {723927.562500, 692.000000},
            {724425.000000, 1.000000},
            {724425.000000, 1.000000},
            {724425.000000, 1.000000},
            {724425.000000, 1.000000},
            {724425.000000, 1.000000},
            {724425.000000, 1.000000},
            {724425.000000, 1.000000},
            {724426.000000, 1.000000},
            {724426.000000, 1.000000},
            {724426.000000, 1.000000},
            {724426.000000, 1.000000},
            {724426.000000, 1.000000},
            {724426.000000, 1.000000},
            {724426.000000, 1.000000},
            {724426.000000, 1.000000},
            {724427.000000, 1.000000},
            {724427.000000, 1.000000},
            {724427.000000, 1.000000},
            {724427.000000, 1.000000},
            {724427.000000, 1.000000},
            {724427.000000, 1.000000},
            {724427.000000, 1.000000},
            {724427.000000, 1.000000},
            {725770.000000, 1.000000},
            {725770.000000, 1.000000},
            {725770.000000, 1.000000},
            {725770.000000, 1.000000},
            {725770.000000, 1.000000},
            {725771.000000, 1.000000},
            {725771.000000, 1.000000},
            {725771.000000, 1.000000},
            {725771.000000, 1.000000},
            {725771.000000, 1.000000},
            {725771.000000, 1.000000},
            {725771.000000, 1.000000},
            {725772.000000, 1.000000},
            {725772.000000, 1.000000},
            {725772.000000, 1.000000},
            {725772.000000, 1.000000}};

        verify_test_data(test_data);
    }

    SECTION("problem 6")
    {
        auto test_data = std::vector<std::pair<float, float>>{
            {152.672333, 40.000000},
            {5204.619141, 1734.000000},
            {71201.976562, 76237.000000},
            {318813.656250, 2426774.000000},
            {545774.562500, 5881958.000000},
            {909414.187500, 468839.000000},
            {917987.937500, 11174.000000},
            {918424.625000, 253.000000},
            {958303.187500, 5.000000},
            {971124.687500, 1.000000},
            {974854.125000, 1.000000},
            {976435.312500, 1.000000},
            {985047.187500, 1.000000},
            {994644.250000, 11186.000000},
            {995414.625000, 1.000000},
            {997873.562500, 253.000000},
            {999215.500000, 1.000000},
            {999215.500000, 4.000000},
            {999312.250000, 1.000000}};
        verify_test_data(test_data);
    }

    SECTION("problem 7")
    {
        auto test_data = std::vector<std::pair<float, float>>{
            {64.961685, 12.000000},          {676.200134, 121.000000},
            {5783.845215, 1340.000000},      {11267.494141, 1.000000},
            {11355.703125, 1.000000},        {15447.041992, 1.000000},
            {27718.292969, 1.000000},        {27879.410156, 1.000000},
            {36912.128906, 14774.000000},    {42895.164062, 1.000000},
            {52293.578125, 1.000000},        {55103.351562, 1.000000},
            {76254.750000, 1.000000},        {77079.078125, 1.000000},
            {83048.812500, 1.000000},        {90299.773438, 1.000000},
            {103370.187500, 1.000000},       {108167.835938, 1.000000},
            {130938.773438, 1.000000},       {138847.812500, 1.000000},
            {150210.171875, 155278.000000},  {154953.765625, 1.000000},
            {164616.859375, 1.000000},       {171261.468750, 1.000000},
            {178008.750000, 1.000000},       {196225.453125, 1.000000},
            {197379.125000, 1.000000},       {200848.218750, 1.000000},
            {229899.921875, 1.000000},       {262163.187500, 1.000000},
            {267186.343750, 1.000000},       {274717.843750, 1.000000},
            {294362.031250, 1.000000},       {312935.781250, 1.000000},
            {320120.062500, 1.000000},       {322380.468750, 1.000000},
            {332329.156250, 1.000000},       {337041.437500, 1.000000},
            {338103.687500, 1.000000},       {339991.593750, 1.000000},
            {344610.125000, 1077105.000000}, {353325.375000, 1.000000},
            {354507.562500, 1.000000},       {364012.437500, 1.000000},
            {371175.500000, 1.000000},       {378079.187500, 1.000000},
            {407243.093750, 1.000000},       {410217.093750, 1.000000},
            {413384.968750, 1.000000},       {413579.562500, 1.000000},
            {417219.343750, 1.000000},       {425331.906250, 1.000000},
            {431854.593750, 1.000000},       {436451.218750, 1.000000},
            {460212.812500, 1.000000},       {478744.156250, 1.000000},
            {481964.562500, 1.000000},       {482030.156250, 1.000000},
            {494829.406250, 1.000000},       {496197.093750, 1.000000},
            {518990.000000, 1.000000},       {526556.125000, 1.000000},
            {527758.437500, 1.000000},       {530000.937500, 1.000000},
            {546368.687500, 1633613.000000}, {548613.687500, 1.000000},
            {553310.937500, 1.000000},       {554450.125000, 1.000000},
            {559677.375000, 1.000000},       {561821.375000, 1.000000},
            {565117.812500, 1.000000},       {568249.062500, 1.000000},
            {582612.687500, 1.000000},       {584684.750000, 1.000000},
            {587071.062500, 1.000000},       {588384.812500, 1.000000},
            {618804.125000, 1.000000},       {623243.750000, 1.000000},
            {624813.437500, 1.000000},       {640835.062500, 1.000000},
            {645844.250000, 1.000000},       {648669.625000, 1.000000},
            {651279.375000, 1.000000},       {660042.312500, 1.000000},
            {679789.937500, 1.000000},       {693179.125000, 1.000000},
            {704729.937500, 1.000000},       {752674.625000, 1.000000},
            {753982.812500, 1.000000},       {757928.250000, 1.000000},
            {765589.625000, 1.000000},       {775975.062500, 1.000000},
            {783743.687500, 1.000000},       {783927.187500, 1.000000},
            {791538.250000, 1.000000},       {794483.875000, 1.000000},
            {798069.812500, 1.000000},       {804765.687500, 1.000000},
            {811615.187500, 1.000000},       {845576.187500, 385932.000000},
            {849600.562500, 1.000000},       {867687.437500, 1.000000},
            {867916.500000, 1.000000},       {868914.062500, 1.000000},
            {874507.062500, 1.000000},       {876108.000000, 1.000000},
            {880257.875000, 1.000000},       {928344.937500, 1.000000},
            {929799.187500, 1.000000},       {939079.437500, 1.000000},
            {940263.062500, 1.000000},       {940404.625000, 1.000000},
            {943533.937500, 1.000000},       {950454.812500, 1.000000},
            {957987.062500, 1.000000},       {960324.750000, 1.000000},
            {977627.312500, 39981.000000},   {979337.062500, 1.000000},
            {987245.875000, 1.000000},       {992791.125000, 1.000000},
            {993843.000000, 1.000000},       {995412.500000, 3657.000000},
            {998304.687500, 331.000000},     {999442.250000, 30.000000},
            {999533.500000, 2.000000}};
        verify_test_data(test_data);
    }
}
