# CPU Module

The **CPU** module is a part of OpenPerf, producing CPU load.

## CPU Generator

Functional unit of OpenPerf CPU module, providing an ability for the CPU load generation.

### CPU Generator API Model

* **id** - unique CPU generator identifier. If empty, then UUID identifier will be generated by the module.
* **running** - current activity status of the generator.
* **config** - configuration of the CPU generator.
    * **method** - method of making the CPU load.

Particular configuration of the CPU generator depends on `method` value, defined in configuration. The selected `method` specifies the configuration parameters.

Available `method` values:
* **system** - generates the general system load.
* **cores** - fine tunable configuration.

### System Method

CPU generator configuration in the _system_ mode defines system-wide load. In the system load mode the CPU generator will keep the requested utilization level for whole OpenPerf process. This means that any load of CPU, making by another generators, will be accounted by the CPU generator.

The CPU generator will create one thread for each _available_ core. The overall load will be spreaded between _available_ cores. Pay attention that _available_ cores for the CPU generator not equal the available cores for operating system, because cores for the OpenPerf and the CPU generator in particular can be limited by the affinity mask of process or thread.

The parameter `utilization` can be a real value from _0_ (exclusive) up to _available\_cores * 100_ (inclusive). Thus if 8 cores are available, the maximum value will be _800_. This means that each thread binded to the _available_ core will make the load of 100%.

The load of the system mode is created by the same algorithm as for the cores mode. In system load mode `scalar` instruction set is used with `int32` data type.

```json
{
    "id": "",
    "running": false,
    "config": {
        "method": "system",
        "system": {
            "utilization": 22.5
        }
    }
}
```

* **id** - unique CPU generator identifier. If empty, then UUID identifier will be generated by module.
* **running** - current activity status of generator.
* **config** - configuration of CPU generator.
    * **method** - should be `system` for the system load mode.
    * **system** - the system method configuration.
        * **utilization** - per core utilization value between _0_ and _100.0 * cores_.

### Cores Method

The _cores_ method is the more flexible way to configure a CPU generator. In this mode the CPU generator configuration allows to define per core load configuration. Each core configuration has desired `utilization` and a chain of `targets`. Utilization can be real value between 0 and 100, inclusive 100 and exclusive 0.

Items of the `cores` array will be binded to the available cores sequentially. The size of the `cores` array is limited by number of available cores for the CPU generator. Pay attention that _available_ cores for the CPU generator not equal the available cores in operating system, because cores for the OpenPerf and the CPU generator particular can be limited by the affinity mask of process or thread.

The CPU generator threads can share the core with another threads of the operating system. Therefore CPU generator may not reach the desired load by core in heavy-loaded system.

```json
{
    "id": "",
    "running": false,
    "config": {
        "method": "cores",
        "cores": [
            {
                "utilization": 22.5,
                "targets": [
                    {
                        "instruction_set": "scalar",
                        "data_type": "int32",
                        "weight": 5
                    }, {
                        "instruction_set": "scalar",
                        "data_type": "float64",
                        "weight": 10
                    }
                ]
            }
        ]
    }
}
```

* **id** - unique CPU generator identifier. If empty, then UUID identifier will be generated by module.
* **running** - current activity status of generator.
* **config** - configuration of CPU generator.
    * **method** - should be `cores` for the cores mode.
    * **cores** - array of per core configurations.
        * **utilization** - per core utilization value between _0_ and _100.0_.
        * **targets** - array of targets configurations.
            * **intruction_set** - set of instructions.
            * **data_type** - type of data for load.
            * **weight** - relative weight of task.

### Targets

Target is the algorithm used to generate load. Targets run sequentially in the order of definition. Weight of each target determines amount of use regard another targets in chain.

CPU generator uses the same load generation algorithm for all targets. This algorithm is multiplication of two fixed-size square matrices. One `operation` in results corresponds to one such multiplication.

The `instruction_set` property defines a version of the algorithm that uses SIMD instructions of specified type. The `instruction_set` value can be used with `data_type` in any combination. Support for all instruction sets except _scalar_ is implemented using the ISPC kernel.

The `weight` is the relative execution time of current target regard other targets in same chain. For example, if one taraget has weight 10, and another has weight 50, then the CPU generator will try to run targets in such a way that the second target has five times more CPU time than the first target.

List of available `instruction_set` values:
* **scalar** - use the common scalar CPU instructions.
* **avx** - use AVX instruction set with 128-bit vectors.
* **avx2** - use AVX2 instruction set with 256-bit vectors.
* **avx512** - use AVX-512 instruction set with using 512-bit vectors.
* **sse2** - use SSE2 instruction set with 128-bit vectors.
* **sse4** - use SSE4 instruction set with 128-bit vectors.

List of available `data_type` values:
* **int32** - integer numbers, 32-bit size.
* **int64** - integer numbers, 64-bit size.
* **float32** - floating point numbers, 32-bit size.
* **float64** - floating point numbers, 64-bit size.

## CPU Generator Result

CPU generator result represents statistics of CPU I/O operations, unique for each CPU generator run. When a generator is started new generator result is created. Results are created in active state. When generator is stopped the result will go to inactive state and won't be changed anymore.

### CPU Generator Result API Model

```json
{
    "active": true,
    "id": "2c9d0e5d-a1be-49d2-759d-a2fcd99961ee",
    "generator_id": "e0a5d7c2-58a4-4864-5ee4-d850346f2917",
    "timestamp": "2020-05-18T13:16:47.804564Z",
    "stats": {
        "available": 7011826558,
        "error": 72788,
        "steal": 0,
        "system": 3996000,
        "user": 732173000,
        "utilization": 736169000,
        "cores": [
            {
                "available": 7011826558,
                "error": 72788,
                "steal": 0,
                "system": 3996000,
                "user": 732173000,
                "utilization": 736169000,
                "targets": [
                    {
                        "operations": 18279000
                    },
                    {
                        "operations": 39933000
                    },
                    {
                        "operations": 10503000
                    },
                    {
                        "operations": 4860000
                    }
                ]
            }
        ]
    }
}
```

* **id** - unique identifier of result.
* **active** - indicates whether the result updates periodically.
* **generator_id** - related generator identifier.
* **timestamp** - timestamp of the last update, in ISO 8601 format.
* **stats** - statistics.
    * **available** - available CPU time.
    * **error** - difference between wanted and actual utilization.
    * **steal** - time the hypervisor reported VM were blocked.
    * **system** - system time used, e.g. kernel or system calls.
    * **user** - user time used, e.g. generator load code.
    * **utilization** - CPU time used.
    * **cores** - per core statistics
        * **available** - same as above, but per core.
        * **error** - same as above, but per core.
        * **steal** - same as above, but per core.
        * **system** - same as above, but per core.
        * **user** - same as above, but per core.
        * **utilization** - same as above, but per core.
        * **targets**
            * **operations** - number of operations.


### Create CPU Generator


### Start CPU Generator

Start CPU generator command returns CPU Generator Result, created for the particular start. Response `Location` header contains URI of created result.

### Getting CPU Generator Result

CPU generator statistics can be received by unique ID of statistics

## Commands flow

Further ```<OPENPERF>``` stands for OpenPerf location in format ```host[:port]```.

### Create CPU Generator

## System Load Mode

```bash
curl --verbose --location \
    --request POST 'http://<OPENPERF>/cpu-generators' \
    --header 'Content-Type: application/json' \
    --data-raw '{
        "id": "",
        "running": false,
        "config": {
            "method": "system",
            "system": {
                "utilization": 22.5
            }
        }
    }'
```

Response:
```json
< HTTP/1.1 201 Created
< Content-Type: application/json
< Connection: Close
< Location: /cpu-generators/85be2ac5-6865-4efc-78f1-6615971fb88d
< Content-Length: 120
<
{
    "id": "85be2ac5-6865-4efc-78f1-6615971fb88d",
    "running": false,
    "config": {
        "method":"system",
        "system": {
            "utilization":22.5
        }
    }
}
```


## Cores Mode

```bash
curl --verbose --location \
    --request POST 'http://<OPENPERF>/cpu-generators' \
    --header 'Content-Type: application/json' \
    --data-raw '{
        "id": "",
        "running": false,
        "config": {
            "method": "cores",
            "cores": [
                {
                    "utilization": 22.5,
                    "targets": [
                        {
                            "instruction_set": "scalar",
                            "data_type": "int32",
                            "weight": 5
                        }, {
                            "instruction_set": "scalar",
                            "data_type": "float64",
                            "weight": 10
                        }
                    ]
                }
            ]
        }
    }'
```

Response:
```json
< HTTP/1.1 201 Created
< Content-Type: application/json
< Connection: Close
< Location: /cpu-generators/0a565dac-5a7f-447b-40ec-5fa1f30fa4d0
< Content-Length: 255
<
{
    "id": "0a565dac-5a7f-447b-40ec-5fa1f30fa4d0",
    "running": false,
    "config": {
        "method": "cores",
        "cores": [
            {
                "utilization": 22.5,
                "targets": [
                    {
                        "data_type": "int32",
                        "instruction_set": "scalar",
                        "weight": 5
                    },{
                        "data_type": "float64",
                        "instruction_set": "scalar",
                        "weight": 10
                    }
                ]
            }
        ]
    }
}
```

### Start CPU Generator

```bash
curl --verbose --location --request POST \
  'http://<OPENPERF>/cpu-generators/0a565dac-5a7f-447b-40ec-5fa1f30fa4d0/start'
```

Response:
```json
< HTTP/1.1 201 Created
< Content-Type: application/json
< Connection: Close
< Location: /cpu-generator-results/7286bd27-fa5d-4fea-51f0-4f6f92285321
< Content-Length: 332
<
{
    "active": true,
    "id": "7286bd27-fa5d-4fea-51f0-4f6f92285321",
    "generator_id": "0a565dac-5a7f-447b-40ec-5fa1f30fa4d0",
    "timestamp": "2020-05-18T13:51:25.891662Z",
    "stats": {
        "available": 0,
        "error": 0,
        "steal": 0,
        "system": 0,
        "user": 0,
        "utilization": 0,
        "cores": [
            {
                "available": 0,
                "error": 0,
                "steal": 0,
                "system": 0,
                "targets": null,
                "user": 0,
                "utilization": 0
            }
        ]
    }
}
```

### Stop CPU Generator

```bash
curl --verbose --location --request POST \
    'http://<OPENPERF>/cpu-generators/0a565dac-5a7f-447b-40ec-5fa1f30fa4d0/stop'
```

Response:
```
< HTTP/1.1 204 No Content
< Connection: Close
< Content-Length: 0
<
```

### Get CPU Generator Statistics

```bash
curl --verbose --location --request GET \
    'http://<OPENPERF>/cpu-generator-results/7286bd27-fa5d-4fea-51f0-4f6f92285321'
```

```
< HTTP/1.1 200 OK
< Content-Type: application/json
< Connection: Close
< Content-Length: 461
<
{
    "active": false,
    "id": "7286bd27-fa5d-4fea-51f0-4f6f92285321",
    "generator_id": "0a565dac-5a7f-447b-40ec-5fa1f30fa4d0",
    "timestamp": "2020-05-18T13:56:54.540224Z",
    "stats": {
        "available": 328629204375,
        "error": 262984,
        "steal": 0,
        "system": 353555000,
        "user": 73587753000,
        "utilization": 73941308000,
        "cores": [
            {
                "available": 328629204375,
                "error": 262984,
                "steal": 0,
                "system": 353555000,
                "user": 73587753000,
                "utilization": 73941308000,
                "targets": [
                    {
                        "operations": 2367792000
                    }, {
                        "operations": 4501467000
                    }
                ]
            }
        ]
    }
}
```

### Delete CPU Generator

Active CPU Generator can be deleted. Active statistic of deleted generator goes to inactive state.

```bash
curl --verbose --location --request DELETE \
    'http://<OPENPERF>/cpu-generators/0a565dac-5a7f-447b-40ec-5fa1f30fa4d0'
```

Response:
```
< HTTP/1.1 204 No Content
< Connection: Close
< Content-Length: 0
<
```

### Delete CPU Generator Result

Active CPU Generator Results cannot be deleted.

```bash
curl --verbose --location --request DELETE \
    'http://<OPENPERF>/cpu-generator-results/7286bd27-fa5d-4fea-51f0-4f6f92285321'
```

Response:
```
< HTTP/1.1 204 No Content
< Connection: Close
< Content-Length: 0
<
```

### Get CPU Info

```bash
curl --verbose --location --request GET \
    'http://<OPENPERF>/cpu-info'
```

Response:
```json
< HTTP/1.1 200 OK
< Content-Type: application/json
< Connection: Close
< Content-Length: 56
<
{
    "architecture": "x86_64",
    "cache_line_size": 64,
    "cores": 4
}
```

## Dynamic Results field names

### Common statistics:
* **available** - available CPU time.
* **error** - difference between wanted and actual utilization.
* **steal** - time the hypervisor reported VM were blocked.
* **system** - system time used, e.g. kernel or system calls.
* **user** - user time used, e.g. generator load code.
* **utilization** - CPU time used.

### Per *core* statistics:

To access to the particular statitics of a configured core, use an appropriate core number instead of *N* below. The core number is the integer value from 0 to number core configuration blocks in the generator configuration minus 1. The order of cores are preserved. The core number refer to core number of system.

* **cores[*N*].available** - available CPU time.
* **cores[*N*].error** - difference between wanted and actual utilization.
* **cores[*N*].steal** - time the hypervisor reported VM were blocked.
* **cores[*N*].system** - system time used, e.g. kernel or system calls.
* **cores[*N*].user** - user time used, e.g. generator load code.
* **cores[*N*].utilization** - CPU time used.

### Per *target* statistics:

By analogy with *cores* use appropriate *target* number, instead of *T* below.

* **cores[*N*].targets[*T*].operations** - number of operations.
