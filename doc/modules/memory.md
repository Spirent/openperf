# Memory Module

The **Memory** module is a part of OpenPerf, producing I/O random access memory (RAM) load.

## Memory Generator

Functional unit of OpenPerf memory module, providing an ability for memory I/O load generation.

### Memory Generator API Model

```json
{
	"id": "",
	"running": false,
	"config": {
		"buffer_size": 102400,
		"reads_per_sec": 1000,
		"read_size": 8,
		"read_threads": 5,
		"writes_per_sec": 1000,
		"write_size": 8,
		"write_threads": 2,
		"pattern": "random"
	}
}
```

* **id** - unique memory generator identifier. If empty, then UUID identifier will be generated by module.
* **running** - current activity status of generator.
* **config** - configuration of memory generator.
    * **buffer_size** - size of buffer, shared between read/write threads, to perform read/write operations respectively.
    * **read_size** - size of block (in bytes) to perform read operations from shared buffer.
    * **read_threads** - number of simulataneously executed read threads of generator.
    * **reads_per_sec** - total number of reads per second for all executed read threads.
    * **write_size** - size of block (in bytes) to perform write operations to shared buffer.
    * **write_threads** - number of simulataneously executed write threads of generator.
    * **writes_per_sec** - total number of writes per second for all executed write threads.
    * **pattern** - pattern of I/O operations, available values are:
        * **random**
        * **sequential**
        * **reverse**

## Memory Generator Result

Memory generator result represents statistics of memory I/O operations, unique for each memory generator run. When a generator is started new generator result is created. Results are created in active state. When generator is stopped the result will go to inactive state and won't be changed anymore.

### Memory Generator Result API Model

```json
{
    "active": true,
    "generator_id": "f6cd944d-d707-4b0e-4a1e-9df972ffd878",
    "id": "8b450692-7798-4ee7-4f0f-1c5e4e3fbee7",
    "read": {
        "bytes_actual": 80,
        "bytes_target": 80,
        "io_errors": 0,
        "latency_total": 12652,
        "latency_max": 12652,
        "latency_min": 12652,
        "ops_actual": 10,
        "ops_target": 10
    },
    "start_timestamp": "2020-05-05T01:28:48.171817866Z",
    "timestamp": "2020-05-05T01:28:50.754598866Z",
    "write": {
        "bytes_actual": 0,
        "bytes_target": 0,
        "io_errors": 0,
        "latency_total": 0,
        "ops_actual": 0,
        "ops_target": 0
    }
}
```

* **id** - unique identifier of result.
* **active** - indicates whether the result updates periodically.
* **generator_id** - related generator identifier.
* **timestamp** - timestamp of the last update, in ISO 8601 format.
* **start_timestamp** - timestamp when the related generator has been started, in ISO 8601 format.
* **read** - read operations statistics.
    * **bytes_actual** - the actual number of bytes read or written.
    * **bytes_target** - the intented number of bytes read of written.
    * **io_errors** - the number of I/O errors.
    * **latency_total** - the total amount of time required to perform all operations (in nanoseconds).
    * **latency_max** - the maximum observed latency value (in nanoseconds). Field is absent if latency was not measured yet.
    * **latency_min** - the minimum observed latency value (in nanoseconds). Field is absent if latency was not measured yet.
    * **ops_actual** - the actual number of operations performed
    * **ops_target** - the intended number of operations performed
* **write** - write operations statistics (format same as `read`).

### Create Memory Generator

To create Memory Generator pass the valid API model. Field `id` should be unique. Memory module will generate new unique UUID, if `id` string is empty. Set `read_threads` or `write_threads` to `0` value to ignore read or write operations respectively.

### Start Memory Generator

Start memory generator command returns Memory Generator Result, created for the particular start. Response `Location` header contains URI of created result.

### Getting Memory Generator Result

Active memory generator statistics can be received by ID of generator as well as own unique ID. Inactive statistics can be taken by unique ID only.

## Commands flow

Further ```<OPENPERF>``` stands for OpenPerf location in format ```host[:port]```.

### Create Memory Generator

```bash
curl --verbose --location \
    --request POST 'http://<OPENPERF>/memory-generators' \
    --header 'Content-Type: application/json' \
    --data-raw '{
        "id": "",
        "running": false,
        "config": {
            "buffer_size": 102400,
            "reads_per_sec": 1000,
            "read_size": 8,
            "read_threads": 5,
            "writes_per_sec": 1000,
            "write_size": 8,
            "write_threads": 2,
            "pattern": "random"
        }
    }'
```

Response:
```
< HTTP/1.1 201 Created
< Location: /memory-generators/9ab6d6a8-6319-4ef5-4fc5-cf30f76e71c2
< Connection: Close
< Content-Type: application/json
< Content-Length: 219
<
{
    "id": "9ab6d6a8-6319-4ef5-4fc5-cf30f76e71c2",
    "running": false,
    "config": {
        "buffer_size": 102400,
        "reads_per_sec": 1000,
        "read_size": 8,
        "read_threads": 5,
        "writes_per_sec": 1000
        "write_size": 8,
        "write_threads": 2,
        "pattern": "random",
    }
}
```

### Start Memory Generator

```bash
curl --verbose --location --request POST \
  'http://<OPENPERF>/memory-generators/9ab6d6a8-6319-4ef5-4fc5-cf30f76e71c2/start'
```

Response:
```
< HTTP/1.1 201 Created
< Location: /memory-generator-results/ee5af272-76c7-425f-6a81-eca0d46c7000
< Connection: Close
< Content-Type: application/json
< Content-Length: 405
<
{
    "active": true,
    "id": "ee5af272-76c7-425f-6a81-eca0d46c7000",
    "generator_id": "9ab6d6a8-6319-4ef5-4fc5-cf30f76e71c2",
    "timestamp": "2020-05-05T06:19:42.205480294Z",
    "start_timestamp": "2020-05-05T06:19:42.205480294Z",
    "read": {
        "bytes_actual": 240,
        "bytes_target": 240,
        "io_errors": 0,
        "latency": 17249,
        "latency_max": 7735,
        "latency_min": 3625,
        "ops_actual": 30,
        "ops_target": 30
    },
    "write": {
        "bytes_actual": 0,
        "bytes_target": 0,
        "io_errors": 0,
        "latency": 0,
        "ops_actual": 0,
        "ops_target": 0
    }
}
```

### Stop Memory Generator

```bash
curl --verbose --location --request POST \
    'http://<OPENPERF>/memory-generators/9ab6d6a8-6319-4ef5-4fc5-cf30f76e71c2/stop'
```

Response:
```
< HTTP/1.1 204 No Content
< Connection: Close
< Content-Length: 0
<
```

### Get Memory Generator Statistics

```bash
curl --verbose --location --request GET \
    'http://<OPENPERF>/memory-generator-results/ee5af272-76c7-425f-6a81-eca0d46c7000'
```

```
< HTTP/1.1 200 OK
< Content-Type: application/json
< Connection: Close
< Content-Length: 502
<
{
    "active": false,
    "id": "ee5af272-76c7-425f-6a81-eca0d46c7000",
    "generator_id": "9ab6d6a8-6319-4ef5-4fc5-cf30f76e71c2",
    "timestamp": "2020-05-05T06:32:41.65198337Z",
    "start_timestamp": "2020-05-05T06:19:42.205480294Z",
    "read": {
        "bytes_actual": 31142712,
        "bytes_target": 31142712,
        "io_errors": 0,
        "latency_total": 223961887,
        "latency_max": 375318,
        "latency_min": 205,
        "ops_actual": 3892839,
        "ops_target": 3892839
    },
    "write": {
        "bytes_actual": 12457256,
        "bytes_target": 12457256,
        "io_errors": 0,
        "latency_total": 66308851,
        "latency_max": 634180,
        "latency_min": 136,
        "ops_actual": 1557157,
        "ops_target": 1557157
    }
}
```

### Delete Memory Generator

Active Memory Generator can be deleted. Active statistic of deleted generator goes to inactive state.

```bash
curl --verbose --location --request DELETE \
    'http://<OPENPERF>/memory-generators/9ab6d6a8-6319-4ef5-4fc5-cf30f76e71c2'
```

Response:
```
< HTTP/1.1 204 No Content
< Connection: Close
< Content-Length: 0
<
```

### Delete Memory Generator Result

Active Memory Generator Results cannot be deleted.

```bash
curl --verbose --location --request DELETE \
    'http://<OPENPERF>/memory-generator-results/ee5af272-76c7-425f-6a81-eca0d46c7000'
```

Response:
```
< HTTP/1.1 204 No Content
< Connection: Close
< Content-Length: 0
<
```

### Get Memory Info

```bash
curl --verbose --location --request GET \
    'http://<OPENPERF>/memory-info'
```

Response:
```
< HTTP/1.1 200 OK
< Content-Type: application/json
< Connection: Close
< Content-Length: 51
<
{
    "free_memory": 216485888,
    "total_memory": 4038316032
}
```

## Dynamic Results field names

### For *read* statistics:
* **read.bytes_actual** - the actual number of bytes read.
* **read.bytes_target** - the intended number of bytes read.
* **read.io_errors** - the number of io_errors observed during reading.
* **read.latency_total** - the total amount of time required to perform all read operations (in nanoseconds).
* **read.latency_max** - the maximum observed latency value (in nanoseconds).
* **read.latency_min** - the minimum observed latency value (in nanoseconds).
* **read.ops_actual** - the actual number of read operations performed.
* **read.ops_target** - the intended number of read operations performed.

### For *write* statistics:
* **write.bytes_actual** - the actual number of bytes written.
* **write.bytes_target** - the intended number of bytes written.
* **write.io_errors** - the number of io_errors observed during writing.
* **write.latency_total** - the total amount of time required to perform all write operations (in nanoseconds).
* **write.latency_max** - the maximum observed latency value (in nanoseconds).
* **write.latency_min** - the minimum observed latency value (in nanoseconds).
* **write.ops_actual** - the actual number of wirite operations performed.
* **write.ops_target** - the intended number of write operations performed.
